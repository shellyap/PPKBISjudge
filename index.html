<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPKBIS Showcase Judge Login</title>
    <script src="https://cdn-tailwindcss.vercel.app/"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .view { display: none; }
        .view.active { display: block; }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-overlay.active {
            display: flex;
        }
        .tab-active {
            border-color: #4f46e5;
            color: #4f46e5;
        }
        .online-indicator {
            height: 10px;
            width: 10px;
            background-color: #22c55e; /* green-500 */
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-7xl">

        <div id="login-view" class="view active">
            <div class="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden md:max-w-2xl mt-16">
                <div class="p-8">
                    <h1 class="text-3xl font-bold text-center text-gray-900 mb-2">PPKBIS Showcase Judge Login</h1>
                    <p class="text-center text-gray-500 mb-8">Select your role to continue</p>
                    <form id="login-form">
                        <div class="mb-6">
                            <label for="username" class="block mb-2 text-sm font-medium text-gray-900">Your Name (e.g., Judge 1)</label>
                            <input type="text" id="username" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5" placeholder="Enter your name" required>
                        </div>
                        <div class="mb-6">
                            <label for="role" class="block mb-2 text-sm font-medium text-gray-900">Select Role</label>
                            <select id="role" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                                <option value="judge">Judge</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div id="admin-password-field" class="mb-6" style="display: none;">
                            <label for="password" class="block mb-2 text-sm font-medium text-gray-900">Admin Password</label>
                            <input type="password" id="password" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5" placeholder="•••••••••">
                        </div>
                        <button type="submit" class="w-full text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:outline-none focus:ring-indigo-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Login</button>
                    </form>
                </div>
            </div>
        </div>

        <div id="admin-view" class="view">
            <header class="flex justify-between items-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900">Admin Dashboard</h1>
                <button id="admin-logout" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Logout</button>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-semibold mb-4">Add Presenter</h2>
                        <form id="add-candidate-form" class="space-y-4">
                            <input type="text" id="candidate-name" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" placeholder="Presenter Name" required>
                            <select id="candidate-category" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5">
                                <option value="Poster">Poster Presentation</option>
                                <option value="Oral">Oral Presentation</option>
                                <option value="Workshop">Workshop</option>
                            </select>
                            <button type="submit" class="w-full text-white bg-indigo-600 hover:bg-indigo-700 font-medium rounded-lg text-sm px-5 py-2.5">Add Presenter</button>
                        </form>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-semibold mb-4">Presenter List</h2>
                        <div id="admin-candidate-list" class="space-y-2"></div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-semibold mb-4">Judges Online</h2>
                        <div id="judges-online-list" class="space-y-3"></div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-md">
                           <h2 class="text-2xl font-semibold mb-4">System Controls</h2>
                           <button id="reset-button" class="w-full text-white bg-red-600 hover:bg-red-700 font-medium rounded-lg text-sm px-5 py-2.5">Reset All Scores</button>
                    </div>
                </div>

                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-semibold mb-4">Grand Winner & Category Awards</h2>
                        <div id="winners-board" class="space-y-8">
                            </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-semibold mb-4">Live Rankings (All Presenters)</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50" id="rankings-header">
                                    </thead>
                                <tbody id="rankings-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-semibold mb-4">Detailed Scores & Feedback</h2>
                        <div id="feedback-details-board" class="space-y-6">
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="judge-view" class="view">
             <header class="flex justify-between items-center mb-8">
                <h1 id="judge-header" class="text-4xl font-bold text-gray-900">Judge Panel</h1>
                <button id="judge-logout" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Logout</button>
            </header>
            <div class="mb-4 border-b border-gray-200">
                <nav id="judge-category-tabs" class="-mb-px flex space-x-8" aria-label="Tabs"></nav>
            </div>
            <div id="judge-candidate-cards">
                </div>
        </div>
    </div>
    
    <div id="confirmation-modal" class="modal-overlay">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-medium leading-6 text-gray-900" id="modal-title">Confirm Action</h3>
            <div class="mt-2"><p class="text-sm text-gray-500" id="modal-message">Are you sure?</p></div>
            <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                <button id="modal-confirm-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:col-start-2 sm:text-sm">Confirm</button>
                <button id="modal-cancel-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:col-start-1 sm:text-sm">Cancel</button>
            </div>
        </div>
    </div>

    <script type="module">
        // The script has been wrapped in a DOMContentLoaded event listener to ensure all HTML elements are available before the script runs.
        document.addEventListener("DOMContentLoaded", () => {
            const firebaseApp = "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            const firebaseAuth = "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            const firebaseFirestore = "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

            Promise.all([
                import(firebaseApp),
                import(firebaseAuth),
                import(firebaseFirestore)
            ]).then((modules) => {
                // ADDED 'query' and 'where' for more robust Firestore querying
                const { initializeApp } = modules[0];
                const { getAuth, signInAnonymously, signInWithCustomToken } = modules[1];
                const { getFirestore, doc, setDoc, addDoc, deleteDoc, onSnapshot, collection, serverTimestamp, writeBatch, getDocs, query, where } = modules[2];

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'ppkbis-judging-default';
                
                // Prioritize environment's config, fall back to user's hardcoded keys for local testing.
                const firebaseConfig = typeof __firebase_config !== 'undefined' 
                    ? JSON.parse(__firebase_config)
                    : {
                        apiKey: "AIzaSyDCTebeG42Vj1G9TRIApiLhwfsxng5mP0Y",
                        authDomain: "ppkbis-shell.firebaseapp.com",
                        projectId: "ppkbis-shell",
                        storageBucket: "ppkbis-shell.firebasestorage.app",
                        messagingSenderId: "942093342515",
                        appId: "1:942093342515:web:29a844b91ba357835a9046",
                        measurementId: "G-M5Q9NCD7JF"
                      };

                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                const auth = getAuth(app);
                
                (async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else { await signInAnonymously(auth); }
                    const userId = auth.currentUser?.uid || `anonymous-${crypto.randomUUID()}`;

                    const CATEGORIES = {
                        'Poster': [
                            { name: 'Content & Relevance', max: 35, desc: 'Clear coverage of 5 sections; relevant to ELT.' },
                            { name: 'Organisation & Clarity', max: 20, desc: 'Logical flow, concise writing, easy to follow.' },
                            { name: 'Visual Design & Layout', max: 20, desc: 'Layout, size compliance, clear fonts, balanced visuals.' },
                            { name: 'Engagement & Communication', max: 25, desc: 'Presenter explains poster confidently & interacts.' }
                        ],
                        'Oral': [
                            { name: 'Content & Relevance', max: 35, desc: 'Clear coverage of 5 sections, relevant to ELT.' },
                            { name: 'Organisation & Clarity', max: 20, desc: 'Logical sequence, smooth flow, well-timed.' },
                            { name: 'Slide Design', max: 15, desc: 'Professional layout, readability, effective visuals.' },
                            { name: 'Delivery & Engagement', max: 30, desc: 'Clear speech, confidence, manages Q&A well, engages audience.' }
                        ],
                        'Workshop': [
                            { name: 'Content & Relevance', max: 35, desc: '5 sections covered, practical & relevant to ELT.' },
                            { name: 'Organisation & Facilitation', max: 20, desc: 'Clear structure, smooth transitions, time control.' },
                            { name: 'Engagement & Interaction', max: 25, desc: 'Active participant involvement, inclusive facilitation.' },
                            { name: 'Resources & Materials', max: 20, desc: 'Quality & usefulness of handouts/slides/materials.' }
                        ]
                    };
                    const CATEGORY_NAMES = Object.keys(CATEGORIES);
                    const FIXED_JUDGE_COUNT = 3;

                    let currentUser = null;
                    let unsubscribeCandidates = () => {};
                    let unsubscribeScores = () => {};
                    let unsubscribePresence = () => {};
                    let activeJudgeCategory = 'Poster';
                    let presenceInterval = null;
                    let candidateData = []; // To hold current candidates for admin view synchronization
                    
                    const views = { login: document.getElementById('login-view'), admin: document.getElementById('admin-view'), judge: document.getElementById('judge-view') };

                    function showView(viewName) {
                        Object.values(views).forEach(view => view.classList.remove('active'));
                        if (views[viewName]) views[viewName].classList.add('active');
                    }

                    async function handleLogin(e) {
                        e.preventDefault();
                        const username = document.getElementById('username').value.trim();
                        const role = document.getElementById('role').value;
                        if (!username) { alert("Please enter your name."); return; }

                        if (role === 'admin') {
                            const password = document.getElementById('password').value;
                            if (password !== 'admin123') {
                                alert('Incorrect admin password.');
                                return;
                            }
                        }

                        currentUser = { id: `${username.replace(/\s+/g, '-')}-${userId.substring(0,4)}`, name: username, role };
                        
                        if (role === 'admin') { 
                            showView('admin'); 
                            initAdminView(); 
                        } else { 
                            document.getElementById('judge-header').textContent = `Judge Panel - ${currentUser.name}`;
                            const presenceRef = doc(db, `artifacts/${appId}/public/data/presence`, currentUser.id);
                            const updatePresence = () => setDoc(presenceRef, { name: currentUser.name, lastSeen: serverTimestamp() });
                            await updatePresence();
                            presenceInterval = setInterval(updatePresence, 20000); // Update every 20 seconds
                            showView('judge'); 
                            initJudgeView(); 
                        }
                    }

                    async function handleLogout() {
                        if (currentUser.role === 'judge') {
                            clearInterval(presenceInterval);
                            await deleteDoc(doc(db, `artifacts/${appId}/public/data/presence`, currentUser.id));
                        }
                        unsubscribeCandidates();
                        unsubscribeScores();
                        unsubscribePresence();
                        currentUser = null;
                        document.getElementById('username').value = '';
                        showView('login');
                    }

                    function initAdminView() {
                        // 1. Candidate List Listener (for Add/Delete on the Admin side)
                        unsubscribeCandidates = onSnapshot(collection(db, `artifacts/${appId}/public/data/candidates`), (snapshot) => {
                            candidateData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            // Re-render the candidate list UI and trigger score recalculation
                            renderAdminCandidateList(candidateData);
                        });

                        // 2. Scores/Rankings Listener (for real-time dashboard updates)
                        unsubscribeScores = onSnapshot(collection(db, `artifacts/${appId}/public/data/scores`), async (scoreSnapshot) => {
                            const scores = scoreSnapshot.docs.map(d => d.data());
                            
                            // Fetch fresh feedback data
                            const feedbackSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/feedback`));
                            const feedbacks = feedbackSnapshot.docs.map(d => d.data());
                            
                            // Use the candidateData captured from the other listener
                            calculateAndDisplayResults(candidateData, scores, feedbacks);
                        });
                        
                        // 3. Presence Listener
                        unsubscribePresence = onSnapshot(collection(db, `artifacts/${appId}/public/data/presence`), (snapshot) => {
                            renderOnlineJudges(snapshot.docs);
                        });
                    }
                    
                    async function handleAddCandidate(e) {
                        e.preventDefault();
                        const candidateNameInput = document.getElementById('candidate-name');
                        const candidateName = candidateNameInput.value.trim();
                        const category = document.getElementById('candidate-category').value;
                        if (candidateName) {
                            await addDoc(collection(db, `artifacts/${appId}/public/data/candidates`), { name: candidateName, category });
                            candidateNameInput.value = '';
                        }
                    }

                    async function deleteCandidate(candidateId) {
                        if (await showConfirmationModal('Delete Presenter', `This will delete the presenter and ALL associated scores and feedback. Are you sure?`)) {
                            const batch = writeBatch(db);

                            // 1. Delete Candidate Document
                            batch.delete(doc(db, `artifacts/${appId}/public/data/candidates`, candidateId));

                            // 2. Delete all related Score documents (scores collection)
                            const scoresQuery = query(collection(db, `artifacts/${appId}/public/data/scores`), where("candidateId", "==", candidateId));
                            const scoresSnapshot = await getDocs(scoresQuery);
                            scoresSnapshot.docs.forEach(d => batch.delete(d.ref));

                            // 3. Delete all related Feedback documents (feedback collection)
                            const feedbackSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/feedback`));
                            feedbackSnapshot.docs.filter(d => d.data().candidateId === candidateId || d.id.startsWith(`${candidateId}_`)).forEach(d => batch.delete(d.ref));

                            await batch.commit();
                        }
                    }
                    
                    function renderOnlineJudges(presenceDocs) {
                        const listEl = document.getElementById('judges-online-list');
                        if(!listEl) return;
                        listEl.innerHTML = '';
                        const now = Date.now();
                        presenceDocs.forEach(docSnap => {
                            const data = docSnap.data();
                            if (data.lastSeen && (now - data.lastSeen.toDate().getTime()) < 30000) { // 30 second threshold
                                const div = document.createElement('div');
                                div.className = 'flex items-center bg-gray-100 p-2 rounded-lg';
                                div.innerHTML = `<span class="online-indicator mr-3"></span><span class="font-medium text-gray-700">${data.name}</span>`;
                                listEl.appendChild(div);
                            }
                        });
                           if (!listEl.hasChildNodes()) {
                                listEl.innerHTML = '<p class="text-gray-500 text-sm">No judges currently online.</p>';
                            }
                    }

                    function renderAdminCandidateList(candidates) {
                        const listEl = document.getElementById('admin-candidate-list');
                        if(!listEl) return;
                        listEl.innerHTML = candidates.length ? '' : '<p class="text-gray-500">No presenters added yet.</p>';
                        candidates.sort((a,b) => a.name.localeCompare(b.name)).forEach(c => {
                            const div = document.createElement('div');
                            div.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-lg';
                            div.innerHTML = `<div><span class="text-sm font-medium">${c.name}</span><span class="ml-2 text-xs text-gray-600 bg-gray-200 px-2 py-1 rounded-full">${c.category}</span></div><button data-id="${c.id}" class="delete-candidate-btn text-red-500 hover:text-red-700 text-xs font-bold">DELETE</button>`;
                            listEl.appendChild(div);
                        });
                        document.querySelectorAll('.delete-candidate-btn').forEach(btn => btn.onclick = () => deleteCandidate(btn.dataset.id));
                    }

                    // Original renderDashboard logic merged into the onSnapshot for scores, now called 'calculateAndDisplayResults'
                    
                    function calculateAndDisplayResults(candidates, scores, feedbacks) {
                        const judges = [...new Set(scores.map(s => s.judgeName))].sort();
                        
                        let results = candidates.map(c => {
                            const scoresByJudge = {};
                            judges.forEach(j => {
                                const judgeScores = scores.filter(s => s.candidateId === c.id && s.judgeName === j);
                                scoresByJudge[j] = judgeScores.reduce((sum, s) => sum + s.score, 0);
                            });
                            const totalScores = Object.values(scoresByJudge).filter(s => s > 0);
                            const judgeCount = totalScores.length;
                            const average = judgeCount > 0 ? totalScores.reduce((a, b) => a + b, 0) / judgeCount : 0;
                            return { ...c, scoresByJudge, average: parseFloat(average.toFixed(2)), judgeCount, award: '-' };
                        });

                        // --- Award Calculation Logic (Centralized) ---
                        const fullyJudged = results.filter(r => r.judgeCount === FIXED_JUDGE_COUNT);
                        
                        const winnerMap = new Map();
                        const categoryWinners = {};
                        
                        CATEGORY_NAMES.forEach(cat => {
                            const catResults = fullyJudged.filter(r => r.category === cat);
                            const gold = catResults.filter(r => r.average >= 85).sort((a,b) => b.average - a.average);
                            const silver = catResults.filter(r => r.average >= 70 && r.average < 85).sort((a,b) => b.average - a.average);
                            const bronze = catResults.filter(r => r.average >= 55 && r.average < 70).sort((a,b) => b.average - a.average);
                            
                            categoryWinners[cat] = { gold, silver, bronze };
                            
                            // Map all winners for the rankings table rendering
                            [...gold, ...silver, ...bronze].forEach(r => {
                                if (r.average >= 85) winnerMap.set(r.id, {level: 'Gold', class: 'bg-yellow-400 text-white'});
                                else if (r.average >= 70) winnerMap.set(r.id, {level: 'Silver', class: 'bg-gray-400 text-white'});
                                else if (r.average >= 55) winnerMap.set(r.id, {level: 'Bronze', class: 'bg-yellow-600 text-white'});
                            });
                        });
                        
                        results.forEach(r => {
                            if(winnerMap.has(r.id)) r.award = winnerMap.get(r.id).level;
                        });

                        const rankings = results.sort((a, b) => b.average - a.average);

                        // --- Render Winner Board (UPDATED STRUCTURE) ---
                        const winnersBoard = document.getElementById('winners-board');
                        if(!winnersBoard) return;
                        winnersBoard.innerHTML = '';
                        
                        // 1. Grand Winner Section
                        const overallRanking = fullyJudged.sort((a,b) => b.average - a.average);
                        const grandWinner = overallRanking.length > 0 ? overallRanking[0] : null;

                        let grandWinnerHTML = `<div class="text-center p-6 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl shadow-lg mb-8">
                            <h3 class="text-2xl font-bold text-white uppercase tracking-wider">Overall Grand Winner (Highest Average Score)</h3>`;
                        if (grandWinner) {
                            grandWinnerHTML += `<p class="text-4xl font-extrabold text-white mt-2">${grandWinner.name} (${grandWinner.category})</p>
                                <p class="text-lg font-medium text-indigo-100">Overall Score: ${grandWinner.average.toFixed(2)}</p>`;
                        } else {
                            grandWinnerHTML += `<p class="text-xl font-semibold text-white mt-2">- Awaiting ${FIXED_JUDGE_COUNT} scores -</p>`;
                        }
                        grandWinnerHTML += `</div>`;
                        winnersBoard.innerHTML += grandWinnerHTML;
                        
                        // 2. Category Winners Section (Separate Cards)
                        winnersBoard.innerHTML += `<h3 class="text-xl font-bold text-gray-900 mb-4">Winners by Category (Minimum ${FIXED_JUDGE_COUNT} Judges)</h3>`;
                        
                        const categoryCardContainer = document.createElement('div');
                        categoryCardContainer.className = 'grid grid-cols-1 md:grid-cols-3 gap-4';

                        CATEGORY_NAMES.forEach(cat => {
                            const catData = categoryWinners[cat];
                            
                            const renderCategoryTier = (title, winners, colorClass) => {
                                let html = `<div class="mt-2"><p class="font-medium text-sm text-gray-700">${title} (${winners.length}):</p>`;
                                if (winners.length > 0) {
                                    html += `<div class="flex flex-wrap gap-2 pt-1">` + winners.map(w =>
                                        `<span class="px-3 py-1 text-xs font-semibold rounded-full ${colorClass} text-white">${w.name} (${w.average.toFixed(2)})</span>`
                                    ).join('') + `</div>`;
                                } else {
                                    html += `<p class="text-xs text-gray-500 italic">None finalized.</p>`;
                                }
                                html += `</div>`;
                                return html;
                            };

                            let categoryHTML = `<div class="bg-gray-100 p-4 rounded-lg shadow-sm h-full flex flex-col">
                                <h4 class="text-xl font-bold text-indigo-700 mb-3 border-b pb-2">${cat}</h4>
                                ${renderCategoryTier('Gold (>=85)', catData.gold, 'bg-yellow-600')}
                                ${renderCategoryTier('Silver (70-84)', catData.silver, 'bg-gray-500')}
                                ${renderCategoryTier('Bronze (55-69)', catData.bronze, 'bg-amber-700')}
                            </div>`;
                            
                            categoryCardContainer.innerHTML += categoryHTML;
                        });
                        winnersBoard.appendChild(categoryCardContainer);


                        // --- Render Rankings Table ---
                        const tableHeader = document.getElementById('rankings-header');
                        if(!tableHeader) return;
                        tableHeader.innerHTML = `<tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Presenter</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                            ${judges.map(j => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${j}</th>`).join('')}
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Judges Submitted</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Average</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Award</th>
                        </tr>`;
                        
                        const rankingsBody = document.getElementById('rankings-body');
                        if(!rankingsBody) return;
                        rankingsBody.innerHTML = '';
                        rankings.forEach(r => {
                            const awardInfo = winnerMap.get(r.id);
                            // Determine the class based on the award level stored in winnerMap
                            let awardClass = 'bg-gray-200 text-gray-800'; // Default for unranked/unjudged
                            if (awardInfo) {
                                awardClass = awardInfo.level === 'Gold' ? 'bg-yellow-400 text-white' : 
                                             (awardInfo.level === 'Silver' ? 'bg-gray-400 text-white' : 'bg-yellow-600 text-white');
                            }
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap font-medium">${r.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.category}</td>
                                ${judges.map(j => `<td class="px-6 py-4 whitespace-nowrap text-sm">${r.scoresByJudge[j] || '-'}</td>`).join('')}
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 font-medium">${r.judgeCount} / ${FIXED_JUDGE_COUNT}</td>
                                <td class="px-6 py-4 whitespace-nowrap font-bold">${r.average.toFixed(2)}</td>
                                <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${awardClass}">${r.award}</span></td>`;
                            rankingsBody.appendChild(row);
                        });

                        // --- Render Detailed Feedback Board (Unchanged) ---
                        const feedbackBoard = document.getElementById('feedback-details-board');
                        if(!feedbackBoard) return;
                        feedbackBoard.innerHTML = '';

                        const judgeMap = new Map();
                        scores.forEach(s => { if (!judgeMap.has(s.judgeId)) judgeMap.set(s.judgeId, s.judgeName) });

                        const augmentedFeedbacks = feedbacks.map(f => ({ ...f, judgeName: judgeMap.get(f.judgeId) || 'Unknown' }));

                        if (rankings.length === 0) {
                            feedbackBoard.innerHTML = '<p class="text-gray-500">No presenters have been scored yet.</p>';
                        } else {
                            rankings.forEach(candidate => {
                                const feedbackForCandidate = augmentedFeedbacks.filter(f => f.candidateId === candidate.id);
                                const judgesWhoScored = Object.keys(candidate.scoresByJudge).filter(j => candidate.scoresByJudge[j] > 0);

                                let candidateFeedbackHTML = `<div class="bg-gray-50 p-4 rounded-lg"><h3 class="text-lg font-bold text-indigo-700">${candidate.name}</h3><div class="mt-3 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">`;

                                if (judgesWhoScored.length > 0) {
                                    judgesWhoScored.forEach(judgeName => {
                                        const judgeFeedback = feedbackForCandidate.find(f => f.judgeName === judgeName);
                                        const feedbackText = (judgeFeedback && judgeFeedback.feedbackText) ? judgeFeedback.feedbackText : 'No feedback submitted.';
                                        
                                        candidateFeedbackHTML += `<div class="bg-white p-3 rounded-md shadow-sm">
                                            <div class="flex justify-between items-center border-b pb-2 mb-2">
                                                <p class="font-semibold text-gray-800">${judgeName}</p>
                                                <p class="font-bold text-gray-600">Score: ${candidate.scoresByJudge[judgeName]}</p>
                                            </div>
                                            <p class="text-sm text-gray-600 italic">"${feedbackText}"</p>
                                        </div>`;
                                    });
                                } else {
                                    candidateFeedbackHTML += `<p class="text-sm text-gray-500 col-span-full">No scores or feedback submitted yet for this presenter.</p>`;
                                }
                                candidateFeedbackHTML += `</div></div>`;
                                feedbackBoard.innerHTML += candidateFeedbackHTML;
                            });
                        }
                    }
                    
                    async function handleResetScores() {
                           if (await showConfirmationModal('Reset All Scores', 'This will delete ALL scores and feedback. This action is irreversible.')) {
                               const scoresSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/scores`));
                               const feedbackSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/feedback`));
                               const batch = writeBatch(db);
                               scoresSnapshot.docs.forEach(d => batch.delete(d.ref));
                               feedbackSnapshot.docs.forEach(d => batch.delete(d.ref));
                               await batch.commit();
                           }
                    }

                    function initJudgeView() {
                        unsubscribeCandidates = onSnapshot(collection(db, `artifacts/${appId}/public/data/candidates`), (snapshot) => {
                            renderJudgeUI(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                        });
                    }
                    
                    function renderJudgeUI(candidates) {
                        const tabsContainer = document.getElementById('judge-category-tabs');
                        if(!tabsContainer) return;
                        tabsContainer.innerHTML = '';
                        Object.keys(CATEGORIES).forEach(cat => {
                            const tab = document.createElement('a');
                            tab.href = '#'; tab.textContent = cat; tab.dataset.category = cat;
                            tab.className = `whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${activeJudgeCategory === cat ? 'tab-active' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`;
                            tab.onclick = (e) => { e.preventDefault(); activeJudgeCategory = cat; renderJudgeUI(candidates); };
                            tabsContainer.appendChild(tab);
                        });
                        renderJudgeCards(candidates.filter(c => c.category === activeJudgeCategory));
                    }

                    function renderJudgeCards(candidates) {
                        const container = document.getElementById('judge-candidate-cards');
                        if(!container) return;
                        container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${
                            candidates.length === 0 
                            ? `<p class="text-gray-500 text-center col-span-full mt-8">No presenters in the "${activeJudgeCategory}" category.</p>`
                            : candidates.sort((a,b) => a.name.localeCompare(b.name)).map(c => {
                                const criteria = CATEGORIES[c.category];
                                const maxTotal = criteria.reduce((sum, crit) => sum + crit.max, 0);
                                
                                const criteriaHTML = criteria.map(crit => {
                                    const fieldId = `score-${c.id}-${crit.name.replace(/\W/g, '-')}`;
                                    return `<div class="space-y-1">
                                        <div class="flex justify-between items-center">
                                            <label for="${fieldId}" class="text-sm font-medium text-gray-800">${crit.name} (Max: ${crit.max})</label>
                                            <input type="number" id="${fieldId}" name="${crit.name}" data-max="${crit.max}" min="0" max="${crit.max}" class="score-input w-20 text-center bg-gray-50 border border-gray-300 text-sm rounded-lg p-1.5" required>
                                        </div>
                                        <p class="text-xs text-gray-500">${crit.desc}</p>
                                    </div>`;
                                }).join('');

                                return `<div class="bg-white p-6 rounded-xl shadow-md flex flex-col">
                                    <h2 class="text-2xl font-bold mb-4">${c.name}</h2>
                                    <form data-candidate-id="${c.id}" class="candidate-score-form space-y-4 flex-grow flex flex-col">
                                        <div class="space-y-4 flex-grow">${criteriaHTML}</div>
                                        <div class="text-right font-bold text-lg pt-4 border-t">Total: <span class="total-score">0</span> / ${maxTotal}</div>
                                        <div class="mt-4 pt-4 border-t">
                                            <label for="feedback-${c.id}" class="block text-sm font-medium text-gray-700 mb-1">Feedback</label>
                                            <textarea id="feedback-${c.id}" rows="3" class="w-full bg-gray-50 border border-gray-300 text-sm rounded-lg p-2"></textarea>
                                        </div>
                                        <button type="submit" class="w-full mt-4 text-white bg-indigo-600 hover:bg-indigo-700 font-medium rounded-lg text-sm px-5 py-2.5">Submit Scores & Feedback</button>
                                    </form>
                                </div>`;
                            }).join('')
                        }</div>`;
                        
                        populateJudgeForms(candidates);
                    }

                    async function populateJudgeForms(candidates) {
                        const scoresSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/scores`));
                        const feedbackSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/feedback`));
                        
                        candidates.forEach(c => {
                            const form = document.querySelector(`form[data-candidate-id="${c.id}"]`);
                            if (!form) return;

                            let currentTotal = 0;
                            const criteria = CATEGORIES[c.category];
                            criteria.forEach(crit => {
                                const scoreDoc = scoresSnapshot.docs.find(d => {
                                    const data = d.data();
                                    return data.candidateId === c.id && data.judgeId === currentUser.id && data.category === crit.name;
                                });
                                if (scoreDoc) {
                                    const scoreData = scoreDoc.data();
                                    const input = form.querySelector(`[name="${scoreData.category}"]`);
                                    if (input) {
                                        input.value = scoreData.score;
                                        currentTotal += scoreData.score;
                                    }
                                }
                            });
                            form.querySelector('.total-score').textContent = currentTotal;

                            const feedbackDoc = feedbackSnapshot.docs.find(d => d.id === `${c.id}_${currentUser.id}`);
                            if (feedbackDoc) {
                                form.querySelector(`#feedback-${c.id}`).value = feedbackDoc.data().feedbackText;
                            }
                            
                            // FIX: Ensure live total is updated on load
                            updateLiveTotal(form); 
                        });
                    }
                    
                    function updateLiveTotal(form) {
                           let total = 0;
                           form.querySelectorAll('.score-input').forEach(i => { total += parseInt(i.value, 10) || 0; });
                           form.querySelector('.total-score').textContent = total;
                    }

                    async function handleScoreSubmit(e) {
                        e.preventDefault();
                        const form = e.target;
                        const button = form.querySelector('button[type="submit"]');
                        button.disabled = true;
                        button.textContent = 'Submitting...';

                        const candidateId = form.dataset.candidateId;
                        const batch = writeBatch(db);

                        form.querySelectorAll('.score-input').forEach(input => {
                            const category = input.name;
                            const score = parseInt(input.value, 10) || 0;
                            const scoreId = `${candidateId}-${currentUser.id}-${category.replace(/\W/g, '-')}`;
                            const scoreRef = doc(db, `artifacts/${appId}/public/data/scores`, scoreId);
                            batch.set(scoreRef, { candidateId, judgeId: currentUser.id, judgeName: currentUser.name, category, score });
                        });
                        
                        const feedbackText = form.querySelector('textarea').value;
                        const feedbackId = `${candidateId}_${currentUser.id}`;
                        const feedbackRef = doc(db, `artifacts/${appId}/public/data/feedback`, feedbackId);
                        batch.set(feedbackRef, { candidateId, judgeId: currentUser.id, feedbackText });

                        await batch.commit();
                        button.textContent = 'Submitted!';
                        setTimeout(() => {
                            button.disabled = false;
                            button.textContent = 'Submit Scores & Feedback';
                        }, 2000);
                    }

                    function showConfirmationModal(title, message) {
                        return new Promise((resolve) => {
                            const modal = document.getElementById('confirmation-modal');
                            modal.querySelector('#modal-title').textContent = title;
                            modal.querySelector('#modal-message').textContent = message;
                            modal.classList.add('active');
                            const confirmBtn = modal.querySelector('#modal-confirm-btn');
                            const cancelBtn = modal.querySelector('#modal-cancel-btn');
                            const close = (result) => {
                                modal.classList.remove('active');
                                confirmBtn.replaceWith(confirmBtn.cloneNode(true));
                                cancelBtn.replaceWith(cancelBtn.cloneNode(true));
                                resolve(result);
                            };
                            modal.querySelector('#modal-confirm-btn').onclick = () => close(true);
                            modal.querySelector('#modal-cancel-btn').onclick = () => close(false);
                        });
                    }
                    
                    // --- Event Listeners ---
                    document.getElementById('login-form').addEventListener('submit', handleLogin);
                    document.getElementById('role').addEventListener('change', (e) => {
                        const passwordField = document.getElementById('admin-password-field');
                        passwordField.style.display = e.target.value === 'admin' ? 'block' : 'none';
                    });
                    document.getElementById('add-candidate-form').addEventListener('submit', handleAddCandidate);
                    document.getElementById('reset-button').addEventListener('click', handleResetScores);
                    document.getElementById('admin-logout').addEventListener('click', handleLogout);
                    document.getElementById('judge-logout').addEventListener('click', handleLogout);

                    document.getElementById('judge-candidate-cards').addEventListener('submit', e => {
                        if (e.target.classList.contains('candidate-score-form')) handleScoreSubmit(e);
                    });
                    document.getElementById('judge-candidate-cards').addEventListener('input', e => {
                        if (e.target.classList.contains('score-input')) {
                            const input = e.target;
                            const max = parseInt(input.dataset.max, 10);
                            if (parseInt(input.value) > max) input.value = max;
                            if (parseInt(input.value) < 0) input.value = 0;
                            updateLiveTotal(e.target.closest('form'));
                        }
                    });
                    
                    showView('login');
                })();
            });
        });
    </script>
</body>
</html>